---
import Layout from '@/layouts/Layout.astro'
import { getCollection, render } from 'astro:content'
import Breadcrumbs from '@/components/blog/Breadcrumbs.astro'
import TagPill from '@/components/blog/TagPill.astro'
import TocPanel from '@/components/blog/TocPanel.astro'
import RelatedPosts from '@/components/blog/RelatedPosts.astro'
import { calculateReadTime, formatDate, getPostNavigation, getRelatedPosts } from '@/utils/blog'

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog')
  return blogEntries
    .filter(entry => !entry.data.draft)
    .map(entry => ({
      params: { slug: entry.slug },
      props: { entry }
    }))
}

const { entry } = Astro.props
const { Content, headings } = await render(entry)

const allPosts = (await getCollection('blog')).filter(post => !post.data.draft)
const relatedPosts = getRelatedPosts(allPosts, entry.slug, entry.data.tags ?? [], 3)
const { previous, next } = getPostNavigation(allPosts, entry.slug)
const readTime = calculateReadTime(entry.body)

const faqSchema = entry.data.faq
  ? {
      '@type': 'FAQPage',
      mainEntity: entry.data.faq.map(f => ({
        '@type': 'Question',
        name: f.question,
        acceptedAnswer: {
          '@type': 'Answer',
          text: f.answer
        }
      }))
    }
  : null

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: entry.data.title,
  description: entry.data.description,
  author: { '@type': 'Organization', name: entry.data.author || 'UwekezajiTZ' },
  datePublished: entry.data.pubDate,
  dateModified: entry.data.updatedDate || entry.data.pubDate,
  image: entry.data.heroImage ? new URL(entry.data.heroImage, Astro.site).toString() : undefined,
  url: new URL(`/blog/${entry.slug}`, Astro.site).toString()
}

const combinedSchema = faqSchema
  ? {
      '@context': 'https://schema.org',
      '@graph': [articleSchema, faqSchema]
    }
  : articleSchema
---

<Layout
  title={entry.data.title}
  description={entry.data.description}
  image={entry.data.heroImage}
  type='article'
  publishedTime={entry.data.pubDate.toISOString()}
  modifiedTime={(entry.data.updatedDate || entry.data.pubDate).toISOString()}
  schema={combinedSchema}
>
  <section class='py-10 sm:py-16'>
    <div class='mx-auto max-w-6xl px-4 sm:px-6 lg:px-8'>
      <div class='grid gap-10 lg:grid-cols-[1fr,320px] lg:items-start'>
        <article class='space-y-8'>
          <Breadcrumbs
            items={[
              { label: 'Mwanzo', href: '/' },
              { label: 'Blog', href: '/blog' },
              { label: entry.data.title }
            ]}
          />
          <div class='space-y-4'>
            <div class='flex flex-wrap items-center gap-3 text-sm text-muted-foreground'>
              <span>{formatDate(entry.data.pubDate)}</span>
              <span class='text-border'>•</span>
              <span>{readTime} min kusoma</span>
            </div>
            <h1 class='text-4xl font-bold text-foreground sm:text-5xl'>{entry.data.title}</h1>
            <p class='text-lg text-muted-foreground'>{entry.data.description}</p>
            <div class='flex flex-wrap gap-2'>
              {entry.data.tags?.map(tag => <TagPill tag={tag} />)}
            </div>
          </div>

          {entry.data.heroImage && (
            <img
              src={entry.data.heroImage}
              alt={entry.data.title}
              class='w-full rounded-xl object-cover'
              loading='lazy'
            />
          )}

          <div class='prose prose-neutral max-w-none dark:prose-invert'>
            <Content />
          </div>

          {entry.data.faq && (
            <div class='space-y-4 rounded-xl border border-border bg-card/40 p-4 shadow-sm'>
              <h2 class='text-2xl font-semibold text-foreground'>Maswali Yanayoulizwa Mara kwa Mara</h2>
              <div class='space-y-3'>
                {entry.data.faq.map(item => (
                  <div class='space-y-1'>
                    <p class='font-semibold text-foreground'>Q: {item.question}</p>
                    <p class='text-muted-foreground'>A: {item.answer}</p>
                  </div>
                ))}
              </div>
            </div>
          )}

          <div class='flex flex-wrap gap-3 border-t border-border pt-6 text-sm font-medium text-primary'>
            {entry.data.tags?.map(tag => <TagPill tag={tag} />)}
          </div>

          <div class='flex items-center justify-between gap-4 border-t border-border pt-6 text-sm'>
            {previous ? (
              <a href={`/blog/${previous.slug}`} class='rounded-md border px-4 py-2 hover:bg-muted'>
                ← {previous.data.title}
              </a>
            ) : (
              <span />
            )}
            {next ? (
              <a href={`/blog/${next.slug}`} class='rounded-md border px-4 py-2 hover:bg-muted'>
                {next.data.title} →
              </a>
            ) : (
              <span />
            )}
          </div>
        </article>

        <div class='space-y-6'>
          <TocPanel headings={headings} />
          {relatedPosts.length > 0 && (
            <div class='rounded-xl border border-border bg-card/40 p-4 shadow-sm'>
              <h3 class='mb-3 text-lg font-semibold text-foreground'>Makala zinazohusiana</h3>
              <ul class='space-y-3 text-sm'>
                {relatedPosts.map(post => (
                  <li class='leading-snug'>
                    <a class='text-primary hover:underline' href={`/blog/${post.slug}`}>
                      {post.data.title}
                    </a>
                    <div class='text-muted-foreground text-xs'>{formatDate(post.data.pubDate)}</div>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <section class='bg-muted/40 py-12'>
    <div class='mx-auto max-w-6xl px-4 sm:px-6 lg:px-8'>
      <RelatedPosts posts={relatedPosts} />
    </div>
  </section>
</Layout>
